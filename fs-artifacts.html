<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../layout/layout.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../birch-popover/birch-popover.html">
<link rel="import" href="../birch-album-display/birch-album-display.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="../birch-artifact-list-item/birch-artifact-list-item-preview.html">
<link rel="import" href="../birch-artifact-grid-item/birch-artifact-grid-item-preview.html">
<link rel="import" href="../fs-styles/fs-styles.html">

<!-- TODO: REFACTOR THESE THREE COMPONENTS -->
<!--
An element providing a solution to no problem in particular.

Example:

    <fs-artifacts></fs-artifacts>

@group Seed Elements
@element fs-artifacts
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="fs-artifacts">
  <style include='fs-styles'></style>
  <link rel="import" type="css" href="fs-artifacts.css">
  <template>
    <iron-media-query query="(max-width: 979px)" query-matches="{{mobile}}"></iron-media-query>
    <birch-popover viewport-positioning id="popover"></birch-popover>
    <paper-scroll-header-panel id='header' class$='{{_viewTypeClass(listView)}}' condenses condensed-header-height='1'>
      <div class="p-header">
        <i class='loading-icon' hidden='[[_hideLoading(loadingData, loadingView, artifacts)]]'></i>
        <div id="album-display-container" hidden='[[!album.id]]'>
          <birch-album-display data-test='album-info' 
            logged-out='[[readOnly]]'
            read-only='[[_readOnlyAlbum(readOnly, album.editableByCaller)]]'
            show-share
            album='[[album]]'
            show-owner='[[showAlbumOwner]]'
            on-edit-album='_handleDataChange'></birch-album-display>
          <div id="empty-album-notification" class='layout vertical center center-justified' hidden='[[artifacts.length]]'>
            <i hidden='{{_hideIfEitherArgTrue(mobile, readOnly)}}' class="empty-album-image"></i>
            <div class='text-wrap'>
              <h5 hidden='[[readOnly]]'>
                [[i18n('title')]]
              </h5>
              <h5 hidden='[[!readOnly]]'>
                [[i18n('unauth-text')]]
              </h5>
              <p hidden='[[_hideIfEitherArgTrue(mobile, readOnly)]]'>
                [[i18n('text')]]
              </p>
              <p hidden='[[_hideIfEitherArgFalseTrue(mobile, readOnly)]]'>
                [[i18n('text-mobile')]]
              </p>
            </div>
          </div>
        </div>
        <div id="recently-deleted-header" hidden="[[!_same(view, 'recently-deleted')]]">
          <h4>[[i18n('recently_deleted_header')]]</h4>
          <small>[[i18n('recently_deleted_explanation')]]</small>
        </div>
      </div>

      <template is="dom-if" if="[[!listView]]" restamp>
        <iron-list class='flex' id='grid-selector'
          as='artifact'
          grid
          isSelectMode$='[[selectMode]]'
          items='[[artifacts]]'
          multi-selection
          selection-enabled
          scroll-target='[[_boundScroller]]'
          selected-items='{{selectedItems}}'
          on-scroll='_cacheScrollState'>
          <template>
            <div class="item grid-item"
              data-uid$='[[artifact.id]]'
              selected$='[[selected]]'
              on-contextmenu='_handleContextMenu'
              on-dragstart='_handleDragStart'
              on-dragend='_handleDragEnd'
              on-tap='_tryMultiSelect'>
              <template is="dom-if" if="[[artifact.id]]">
                <birch-artifact-grid-item draggable="{{!readOnly}}"
                  data-test='grid-item'
                  read-only='[[readOnly]]'
                  data='[[artifact]]'
                  select-mode='{{selectMode}}'
                  view='[[view]]'
                  show-contributed='[[showContributed]]'
                  show-messages='[[showMessages]]'
                  show-restricted-info='[[showRestrictedInfo]]'
                  owner='[[owner]]'
                  alert-input-active='{{alertInputActive}}'
                  inline-adding-enabled='[[inlineAddingEnabled]]'></birch-artifact-grid-item>
                  <template is="dom-if" if="[[!disableSelect]]">
                    <i class="grid-select check-icon"></i>
                  </template>
              </template>
              <template is="dom-if" if="[[!artifact.id]]">
                <birch-artifact-grid-item-preview
                  data-test='grid-item-preview'
                  data='{{artifact}}'>
                </birch-artifact-grid-item-preview>
              </template>
            </div>
          </template>
        </iron-list>
      </template>
      <template is="dom-if" if="[[listView]]" restamp>
        <iron-list class='flex' id='list-selector'
          as='artifact'
          isSelectMode$='[[selectMode]]'
          items='[[artifacts]]'
          multi-selection
          selection-enabled
          scroll-target='[[_boundScroller]]'
          selected-items='{{selectedItems}}'
          on-scroll='_cacheScrollState'>
          <template>
            <div class="item list-item"
              data-uid$='[[artifact.id]]'
              selected$='[[selected]]'
              on-contextmenu='_handleContextMenu'
              on-dragstart='_handleDragStart'
              on-dragend='_handleDragEnd'
              on-tap='_tryMultiSelect'>
              <template is="dom-if" if="[[artifact.id]]">
                <birch-artifact-list-item draggable="{{!readOnly}}"
                  data-test='list-item'
                  read-only='[[readOnly]]'
                  data='[[artifact]]'
                  mobile='[[mobile]]'
                  view='[[view]]'
                  show-contributed='[[showContributed]]'
                  show-messages='[[showMessages]]'
                  show-restricted-info='[[showRestrictedInfo]]'
                  select-mode='{{selectMode}}'
                  owner='[[owner]]'
                  alert-input-active='{{alertInputActive}}'
                  inline-adding-enabled='[[inlineAddingEnabled]]'></birch-artifact-list-item>
                <template is="dom-if" if="[[!disableSelect]]">
                  <i class="list-select check-icon"></i>
                </template>
              </template>
              <template is="dom-if" if="[[!artifact.id]]">
                <birch-artifact-list-item-preview data-test='grid-item-preview' data='{{artifact}}'></birch-artifact-list-item-preview>
              </template>
            </div>
          </template>
        </iron-list>
      </template>
    </paper-scroll-header-panel>
  </template>
</dom-module>

<script>
(function() {

  var getId = function(obj) {
    return obj.id;
  };

  var getItemById = function(id, list) {
    if (isNaN(parseInt(id, 10)) || !Array.isArray(list)) return;
    var index = list.map(getId).indexOf(parseInt(id));
    return index > -1 ? list[index] : null;
  };

  Polymer({

    is: 'fs-artifacts',
    behaviors: [
      WCI18n(),
      OakI18nBehavior
    ],
    properties: {
      _selectedNodes: {
        type: Array
      },
      _boundScroller: {
        type: Object,
        value: function() {
          return this.$.header.scroller;
        }
      },
      _cachesCalled: {
        type: Boolean,
        value: false
      },
      _domChangeTimeout: {
        type: Boolean,
        value: false
      },
      _domInitialLoad: {
        type: Boolean,
        value: false
      },
      album: {
        type: Object,
        value: function() { return {}; }
      },
      /**
       * Alerts if input box inside of viewer is active.
       */
      alertInputActive: {
        type: Boolean,
        notify: true
      },
      artifacts: {
        type: Array,
        value: function() { return []; },
        observer: '_handleArtifactsChange'
      },
      selectedItems: {
        type: Array,
        notify: true
      },
      loadingData: {
        type: Boolean,
        value: false
      },
      loadingView: {
        type: Boolean,
        notify: true,
        value: false,
        observer: '_loadingViewChange'
      },
      selectOnly: {
        type: Boolean,
        value: false,
        observer: '_handleSelectOnly'
      },
      selectMode: {
        type: Boolean,
        value: false,
        notify: true
      },
      selectOnContextMenu: {
        type: Boolean,
        value: false,
      },
      /**
       * Flag for artifacts to toggle
       * showing the artifact contributor
       */
      showContributed: {
        type: Boolean,
        value: false
      },
      /**
       * Flag for artifacts to toggle
       * processing/screening messages
       */
      showMessages: {
        type: Boolean,
        value: false
      },
      /**
      * A flag for showing the restricted
      * info dialog
      */
      showRestrictedInfo: {
        type: Boolean,
        value: false
      },
      showAlbumOwner: {
        type: Boolean,
        value: false
      },
      /*
        *Boolean for completely removing the ability to select grid items
      */
      disableSelect: {
        type: Boolean,
        value: false
      },
      view: {
        type: String,
        value: 'my-memories',
        observer: '_viewStringChange'
      },
      /**
       * Flag that enables inline adding.
       */
      inlineAddingEnabled: {
        type: Boolean,
        value: false
      },
      listString: {
        type: String,
        computed: '_computeListString(listView)'
      },
      listView: {
        type: Boolean,
        notify: true,
        observer: '_handleViewChange'
      },
      owner: {
        type: String,
        value: null
      },
      readOnly: {
        type: Boolean,
        value: false
      }
    },
    observers: [
      '_handleSelect(selectedItems.length)',
      '_handleDataChange(album.*, artifacts.*)'
    ],
    ready: function() {
      var self = this;
      this.listen(document, 'gallery-deselect-all', 'deselectAll');
      this.listen(this._boundScroller, 'scroll', '_handleScroll');
      // Handle multiple attempts to change the global variable 'alertInputActiveChange'.
      // If user clicks from one input to another, the second input's alertInputActiveChange = true is
      // overwritten by the first input's alertInputActiveChange = false
      this.listen(this, 'alert-input-active-changed', '_handleAlertInputActiveChange')

      // Listens to the list-item preview hover. Handler populates and positions birch-popover.
      this.listen(document, 'list-item-hover', '_handleListItemHover');

      // List item preview mouseout closes birch-popover.
      this.listen(document, 'list-item-mouseout', '_handleListItemMouseout');

      // // Listens for event to open the restricted information dialog
      // this.listen(document, 'open-restricted-info', '_handleRestrictedInfo');

      var galleryData = document.querySelector('gallery-data');
      if (!this._cachesCalled) {
        if (!galleryData || !galleryData.dataLoaded) {
          this.listen(document, 'gallery-data-received', '_loadCaches');
        } else {
          this._loadCaches();
        }
        this._cachesCalled = true;
      }
    },
    detached: function(){
      this.unlisten(document, 'list-item-hover', '_handleListItemHover');
      this.unlisten(document, 'list-item-mouseout', '_handleListItemMouseout');
      // this.unlisten(document, 'open-restricted-info', '_handleRestrictedInfo');
    },
    _same: function(a, b) {
      return a === b;
    },
    _loadCaches: function() {
      this._loadCacheViewType();
      this._loadCacheState(this.view);
    },
    _computeListString: function(listView) {
      return listView ? 'list' : 'grid';
    },
    _handleContextMenu: function(e) {
      if (!this.selectOnContextMenu) return;
      e.preventDefault();
      var target = e.currentTarget;
      var parent = e.currentTarget.parentNode;
      var gParent = parent.parentNode;
      if (!target.hasAttribute('selected')
          && !parent.hasAttribute('selected')
          && !gParent.hasAttribute('selected')) {
        this.deselectAll();
        var selector = this.$$('#' + this.listString + '-selector');
        if (Boolean(selector)) selector.selectItem(getItemById(target.getAttribute('data-uid'), this.artifacts));
      }
    },
    _handleSelectOnly: function(val) {
      if (val) {
        this.selectMode = val;
      }
    },
    _loadCacheState: function(view) {
      var cache = JSON.parse(sessionStorage.getItem('gallery-scroll-target-' + this.owner));
      if (cache && cache[view] && parseInt(cache[view])) {
        (function(target) {
          if (!target) return;
          Polymer.dom.flush();
          this.addEventListener('dom-loaded', function(){
            var selector = Polymer.dom(this.root).querySelector('#' + this.listString + '-selector');
            if (selector) selector.scrollToIndex(target);
          });
        }.bind(this))(parseInt(cache[view]))
      }
    },
    _loadCacheViewType: function() {
      var cache = localStorage.getItem('gallery-view-type-' + this.owner);
      if (cache) {
        this.listView = cache === 'list-view';
        this._cacheViewType();
        this._viewCacheLoaded = true;
      } else {
        this.listView = false;
        this._cacheViewType();
      }
    },
    _handleAlertInputActiveChange: function(e) {
      var val = e.detail.value;
      if (val) {
        this.async(function(){
          this.alertInputActive = true;
        }.bind(this))
      }
    },
    _handleScroll: function() {
      this.debounce('birch-artifact-grid-cache-scroll-state', function() {
        var selector = this.$$('#' + this.listString + '-selector');
        this.fire('artifact-grid-scroll', {
          scrollTarget: selector.firstVisibleIndex
        });
      }.bind(this));
    },
    _handleDataChange: function() {
      this.debounce('birch-artifact-grid-measure-header', function() {
        this.$.header.measureHeaderHeight();
      }.bind(this));
    },
    _handleDragStart: function(e) {
      if (this.readOnly || this.alertInputActive) {
        e.preventDefault();
        return;
      };
      this.fire('toggleUploadDrag', { 'disable' : true });
      e.dataTransfer.setData('text', 'drag');
      var target = e.currentTarget;
      if (!target.classList.contains('iron-selected')) {
        var selector = this.$$('#' + this.listString + '-selector');
        if (Boolean(selector)) selector.selectItem(getItemById(target.getAttribute('data-uid'), this.artifacts));
      }
      // If Using Chrome
        if(navigator.userAgent.indexOf("Chrome") != -1)
        {
          var canvas = document.createElement("canvas");
          canvas.id = "dragIcon";
          var ctx = canvas.getContext("2d");
          ctx.font="12px Verdana";
          ctx.fillStyle="#1A7592";
          var img = new Image();
          var newImage = new Image();

          if (this.selectedItems.length == 1) {
            img.src = "data:image/svg+xml;base64, PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjQycHgiIGhlaWdodD0iNDJweCIgdmlld0JveD0iMCAwIDQyIDQyIiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhtbG5zOnNrZXRjaD0iaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoL25zIj4KICAgIDwhLS0gR2VuZXJhdG9yOiBTa2V0Y2ggMy4zLjMgKDEyMDcyKSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5SZWN0YW5nbGUgNzU0IENvcHkgMyArIFJlY3RhbmdsZSA3NTQgQ29weSA0IENvcHkgKyBCYWRnZXMgLyBOdW1lcmljYWwgb24gV2hpdGUgQ29weSAxNyBDb3B5ICsgT3ZhbCAxMDIgKyBQYXRoIDE4MjQgQ29weSAxNDwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4KICAgIDxkZWZzPjwvZGVmcz4KICAgIDxnIGlkPSJQYWdlLTEiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIHNrZXRjaDp0eXBlPSJNU1BhZ2UiPgogICAgICAgIDxnIGlkPSJkcmFnLWFuZC1kcm9wLWNvcHkiIHNrZXRjaDp0eXBlPSJNU0FydGJvYXJkR3JvdXAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC02Ni4wMDAwMDAsIC05MS4wMDAwMDApIj4KICAgICAgICAgICAgPGcgaWQ9IlJlY3RhbmdsZS03NTQtQ29weS0zLSstUmVjdGFuZ2xlLTc1NC1Db3B5LTQtQ29weS0rLUJhZGdlcy0vLU51bWVyaWNhbC1vbi1XaGl0ZS1Db3B5LTE3LUNvcHktKy1PdmFsLTEwMi0rLVBhdGgtMTgyNC1Db3B5LTE0IiBza2V0Y2g6dHlwZT0iTVNMYXllckdyb3VwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2Ni4wMDAwMDAsIDkxLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPGcgaWQ9IlJlY3RhbmdsZS03NTQtQ29weS0zLSstUmVjdGFuZ2xlLTc1NC1Db3B5LTQtQ29weS0rLUJhZGdlcy0vLU51bWVyaWNhbC1vbi1XaGl0ZS1Db3B5LTE3LUNvcHkiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlPSIjMjdDNEY0IiBmaWxsPSIjRDRGM0ZEIiBza2V0Y2g6dHlwZT0iTVNTaGFwZUdyb3VwIj4KICAgICAgICAgICAgICAgICAgICA8ZyBpZD0iUmVjdGFuZ2xlLTc1NC1Db3B5LTMtKy1SZWN0YW5nbGUtNzU0LUNvcHktNC1Db3B5Ij4KICAgICAgICAgICAgICAgICAgICAgICAgPHJlY3QgaWQ9IlJlY3RhbmdsZS03NTQtQ29weS00IiB4PSIwIiB5PSIwIiB3aWR0aD0iNDEuNjg3NSIgaGVpZ2h0PSI0MS42ODc1IiByeD0iMiI+PC9yZWN0PgogICAgICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgICAgIDxnIGlkPSJPdmFsLTEwMi0rLVBhdGgtMTgyNC1Db3B5LTE0IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNy4yNTExNTksIDQuNTAwMDAwKSIgc2tldGNoOnR5cGU9Ik1TU2hhcGVHcm91cCI+CiAgICAgICAgICAgICAgICAgICAgPGNpcmNsZSBpZD0iT3ZhbC0xMDIiIGZpbGw9IiMyN0M0RjQiIGN4PSI5LjUiIGN5PSI5LjUiIHI9IjkuNSI+PC9jaXJjbGU+CiAgICAgICAgICAgICAgICAgICAgPHBhdGggZD0iTTUuMjY5NDcyNTcsMTAuNDA4NjIxNiBMOC42OTg0MjI2MywxMy4zMjM5NDU1IEwxMy42OCw2LjA4IiBpZD0iUGF0aC0xODI0IiBzdHJva2U9IiNGRkZGRkYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48L3BhdGg+CiAgICAgICAgICAgICAgICA8L2c+CiAgICAgICAgICAgIDwvZz4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==";
            ctx.drawImage(img, 0, 0);
            ctx.fillText(this.selectedItems.length,2,38);
            var url = canvas.toDataURL();
            newImage.src = url;
            e.dataTransfer.setDragImage(newImage, 30, 30);
          } else {
            img.src = "data:image/svg+xml;base64, PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjQ4cHgiIGhlaWdodD0iNDdweCIgdmlld0JveD0iMCAwIDQ4IDQ3IiB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHhtbG5zOnNrZXRjaD0iaHR0cDovL3d3dy5ib2hlbWlhbmNvZGluZy5jb20vc2tldGNoL25zIj4KICAgIDwhLS0gR2VuZXJhdG9yOiBTa2V0Y2ggMy4zLjMgKDEyMDcyKSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5SZWN0YW5nbGUgNzU0IENvcHkgMyArIFJlY3RhbmdsZSA3NTQgQ29weSA0IENvcHkgKyBCYWRnZXMgLyBOdW1lcmljYWwgb24gV2hpdGUgQ29weSAxNyBDb3B5IENvcHkgKyBPdmFsIDEwMiArIFBhdGggMTgyNCBDb3B5IDE1PC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGRlZnM+PC9kZWZzPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCIgc2tldGNoOnR5cGU9Ik1TUGFnZSI+CiAgICAgICAgPGcgaWQ9ImRyYWctYW5kLWRyb3AtY29weSIgc2tldGNoOnR5cGU9Ik1TQXJ0Ym9hcmRHcm91cCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE3NC4wMDAwMDAsIC05MS4wMDAwMDApIj4KICAgICAgICAgICAgPGcgaWQ9IlJlY3RhbmdsZS03NTQtQ29weS0zLSstUmVjdGFuZ2xlLTc1NC1Db3B5LTQtQ29weS0rLUJhZGdlcy0vLU51bWVyaWNhbC1vbi1XaGl0ZS1Db3B5LTE3LUNvcHktQ29weS0rLU92YWwtMTAyLSstUGF0aC0xODI0LUNvcHktMTUiIHNrZXRjaDp0eXBlPSJNU0xheWVyR3JvdXAiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE3NC4wMDAwMDAsIDkxLjAwMDAwMCkiPgogICAgICAgICAgICAgICAgPGcgaWQ9IlJlY3RhbmdsZS03NTQtQ29weS0zLSstUmVjdGFuZ2xlLTc1NC1Db3B5LTQtQ29weS0rLUJhZGdlcy0vLU51bWVyaWNhbC1vbi1XaGl0ZS1Db3B5LTE3LUNvcHktQ29weSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC41MDAwMDAsIDAuMDAwMDAwKSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2U9IiMyN0M0RjQiIGZpbGw9IiNENEYzRkQiIHNrZXRjaDp0eXBlPSJNU1NoYXBlR3JvdXAiPgogICAgICAgICAgICAgICAgICAgIDxnIGlkPSJSZWN0YW5nbGUtNzU0LUNvcHktMy0rLVJlY3RhbmdsZS03NTQtQ29weS00LUNvcHkiPgogICAgICAgICAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTc1NC1Db3B5LTMiIHg9IjUuMzEyNSIgeT0iNS4zMTI1IiB3aWR0aD0iNDEuNjg3NSIgaGVpZ2h0PSI0MS42ODc1IiByeD0iMiI+PC9yZWN0PgogICAgICAgICAgICAgICAgICAgICAgICA8cmVjdCBpZD0iUmVjdGFuZ2xlLTc1NC1Db3B5LTQiIHg9IjAiIHk9IjAiIHdpZHRoPSI0MS42ODc1IiBoZWlnaHQ9IjQxLjY4NzUiIHJ4PSIyIj48L3JlY3Q+CiAgICAgICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPC9nPgogICAgICAgICAgICAgICAgPGcgaWQ9Ik92YWwtMTAyLSstUGF0aC0xODI0LUNvcHktMTUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE3LjI1MTE1OSwgNC41MDAwMDApIiBza2V0Y2g6dHlwZT0iTVNTaGFwZUdyb3VwIj4KICAgICAgICAgICAgICAgICAgICA8Y2lyY2xlIGlkPSJPdmFsLTEwMiIgZmlsbD0iIzI3QzRGNCIgY3g9IjkuNSIgY3k9IjkuNSIgcj0iOS41Ij48L2NpcmNsZT4KICAgICAgICAgICAgICAgICAgICA8cGF0aCBkPSJNNS4yNjk0NzI1NywxMC40MDg2MjE2IEw4LjY5ODQyMjYzLDEzLjMyMzk0NTUgTDEzLjY4LDYuMDgiIGlkPSJQYXRoLTE4MjQiIHN0cm9rZT0iI0ZGRkZGRiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjwvcGF0aD4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPC9nPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+";
            ctx.drawImage(img, 0, 0);
            ctx.fillText(this.selectedItems.length,2,38);
            var url = canvas.toDataURL();
            newImage.src = url;
            e.dataTransfer.setDragImage(newImage, 30, 30);
          }
        }
    },
    _handleSelect: function() {
      this._updateStyles();
    },
    _handleDragEnd: function(e)  {
      if (this.readOnly) return;
      this.fire('toggleUploadDrag', { 'disable' : false });
    },
    _hideLoading: function(loadingData, loadingView, artifacts) {
      if (!loadingView && artifacts && artifacts.length) return true;
      if (loadingView) return false;
      return !loadingData;
    },
    _readOnlyAlbum: function(readOnly, editableByCaller) {
      return readOnly || !editableByCaller;
    },
    _loadingViewChange: function(val) {
      this.$.header.style.visibility = val ? "hidden" : "visible";
    },
    _viewStringChange: function(val) {
      this._loadCacheState(val);
    },
    _handleViewChange: function() {
      this.selectedItems = undefined;

      if (this._viewCacheLoaded) {
        this._cacheViewType();
      }
      this.listen(this.$.header, 'dom-change', '_handleViewDomChange');

      // If dom doesn't appear as ready within 7 seconds, stop polling and display
      // what has been rendered.
      setTimeout(function(){
        clearInterval(pollDom);
        this.loadingView = false;
        this.unlisten(this.$.header, 'dom-change', '_handleViewDomChange');
        if (!this._domInitialLoad) this.fire('dom-loaded');
        this._domInitialLoad = true;
        this._domChangeTimeout = true;
      }.bind(this), 7000);

      // Poll Dom to signal when to display it and turn off spinner.
      var pollDom = setInterval(function() {
        if (!this.isDebouncerActive('fs-artifacts-view-change')) {
          this.loadingView = false;
          clearInterval(pollDom);
          this.unlisten(this.$.header, 'dom-change', '_handleViewDomChange');
          if (!this._domInitialLoad) this.fire('dom-loaded');
          this._domInitialLoad = true;
          this._domChangeTimeout = true;
        }
      }.bind(this), 60)
    },
    _handleViewDomChange: function() {
      this.debounce('fs-artifacts-view-change', function() {
        //Just here to see when the DOM stops loading
      }, 200);
    },
    _cacheViewType: function() {
      var viewType = this.listView ? 'list-view' : 'grid-view';
      this.fire('gallery-view-type-change', {
        viewType: viewType
      });
    },
    _viewTypeClass: function (listView) {
      return listView ? 'fit list-view' : 'fit grid-view';
    },
    _itemClasses: function(listView) {
      var classString = listView ? 'list-item' : 'grid-item';
      return "item " + classString;
    },
    _listView: function(list, artifact) {
      return (list && artifact);
    },
    _gridView: function(list, artifact) {
      return (!list && artifact);
    },
    _newGridItem: function(artifactId, list) {
      return (!artifactId && !list);
    },
    _newListItem: function(artifactId, list) {
      return (!artifactId && list);
    },
    _tryMultiSelect: function(e) {
      // Check that this is a multiselect (select with shift key) with
      // at least one other item selected
      if (!this.selectedItems ||
          !this.selectedItems.length ||
          !e ||
          !e.detail ||
          !e.detail.sourceEvent ||
          !e.detail.sourceEvent.shiftKey) return;
      var event = Polymer.dom(e).event;

      if (event && event.model && event.model.artifact && event.model.artifact.id) {
        var ids = this.artifacts.map(getId);
        var selectedIds = this.selectedItems.map(function(item) {
          return item.id;
        });
        // Compute First Index
        var firstIndex;
        this.selectedItems.forEach(function(artifact) {
          if (firstIndex === undefined) {
            firstIndex = ids.indexOf(artifact.id);
          } else {
            var idx = ids.indexOf(artifact.id);
            firstIndex = (idx < firstIndex && idx !== -1) ? idx : firstIndex;
          }
        });

        var lastIndex = ids.indexOf(event.model.artifact.id);

        if (lastIndex < firstIndex) {
          firstIndex = lastIndex;
          this.selectedItems.forEach(function(artifact) {
            var idx = ids.indexOf(artifact.id);
            lastIndex = (idx > lastIndex && idx !== -1) ? idx : lastIndex;
          });
          lastIndex++;
        }

        this.deselectAll();

        var artifactsToSelect = this.artifacts.filter(function(artifact, index) {
          return index >= firstIndex && index < lastIndex;
        });

        // Wrapping this in a this.async as the tap handler that triggers
        // select fires immediately after this logic. This will defer the
        // select till after that happens.
        this.async(function() {
          var idsToSelect = artifactsToSelect.forEach(function(artifact) {
            var selector = this.$$('#' + this.listString + '-selector');
            selector.selectItem(artifact);
          }.bind(this));
        }.bind(this));
      }
    },
    _updateStyles: function() {
      if (!this.selectOnly) {
        if (this.selectedItems && this.selectedItems.length == 0) this.set('selectMode', false);
        if (this.selectedItems && !this.selectMode && this.selectedItems.length > 0) this.set('selectMode', true);
      }

      // This is a built in Polymer Function to force CSS property/mixin updating within this component
      this.debounce('birch-artifact-grid-update-styles', function() {
        this.updateStyles();
      }.bind(this), 16)
    },
    _handleArtifactsChange: function() {
      var selector = this.$$('#' + this.listString + '-selector');
      if (Boolean(selector)) {
        this.listen(selector, 'dom-change', '_domChangeListener');
      }
    },
    _domChangeListener: function(e) {
      //Added to update selection styles when switching from album to album or my-memories to album
      this.debounce('fs-artifacts-change-listener', function() {
        Polymer.updateStyles();
      }.bind(this), 20);

    },
    deselectAll: function() {
      var selector = Polymer.dom(this.root).querySelector('#' + this.listString + '-selector');
      if (Boolean(selector)) {
        selector.clearSelection();
      }
    },
    _hideIfEitherArgTrue: function(arg1, arg2) {
      return arg1 || arg2;
    },
    _hideIfEitherArgFalseTrue: function(arg1, arg2) {
      return !arg1 || arg2;
    },
    _handleListItemHover: function(e) {
      var contentContainer = document.createElement("div");
      contentContainer.style.width = "200px";
      contentContainer.style.wordWrap = "break-word";
      // Check that data was passed in
      if (!e || !e.detail || !e.detail.data) return;

      if (e.detail.data.category != "TEXT") {
        var image = new Image();
        image.src = e.detail.data.thumbUrl;
        contentContainer.appendChild(image);
      } else {
         if (e.detail.data.title.length > 0) {
           var title = document.createElement('h4');
           title.innerText = e.detail.data.title;
           title.style.marginTop = 0;
           title.style.marginBottom = '15px';
           title.style.height = '2.6em';
           title.style.overflow = 'hidden';
           title.style.fontSize = '16px';
           contentContainer.appendChild(title);
         }
         if (e.detail.data.description.length > 0 || e.detail.data.thumbUrl) {
           var descriptionContainer = document.createElement("div");
           descriptionContainer.style.overflow = 'hidden';

           if (e.detail.data.thumbUrl) {
              var storyImage = new Image();
              storyImage.src = e.detail.data.thumbUrl;
              storyImage.style.height = "50px";
              storyImage.style.width = "auto";
              storyImage.style.float = "left";
              storyImage.style.marginRight = '8px';
              descriptionContainer.appendChild(storyImage);
           }
           if (e.detail.data.description.length > 0) {
             var description = document.createElement("div");
             description.innerText = e.detail.data.description;
             description.style.maxHeight = "132px";
             description.style.marginBottom = 0;

             if (e.detail.data.description.length > 75) {
               var overlay = document.createElement("div");
               overlay.style.position = 'absolute';
               overlay.style.top = '63%';
               overlay.style.bottom = 0;
               overlay.style.left = 0;
               overlay.style.right = 0;
               overlay.style.background = 'linear-gradient(to bottom,rgba(255,255,255,0) 0%,rgba(255,255,255,1) 100%)';
               description.appendChild(overlay);
             }
             descriptionContainer.appendChild(description);
           }
           contentContainer.appendChild(descriptionContainer);
         }
      }
      this.$.popover.setContent(contentContainer, true)
      this.$.popover.positionTarget = e.detail.positionTarget;
      this.$.popover.dialogPosition = 'right';
      this.$.popover.alignment = 'top';
      this.$.popover.alignmentAutoAdjust = true;
      this.$.popover.alignmentBuffer = 0;
      this.$.popover.positionBuffer = 15;
      this.$.popover.open();
    },
    _handleListItemMouseout: function(e) {
      this.$.popover.close();
    }
  });
})();

</script>
